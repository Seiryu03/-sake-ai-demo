#!/bin/bash
# 🛡️ APrise 100点デザイン保護フック
# このファイルは重要なデザインファイルの変更を監視・保護します

echo "🛡️  APrise Design Protection Hook - Checking for protected file modifications..."

# 保護対象ファイル
PROTECTED_FILES=(
    "public/index.html"
    "public/styles-v2.css"
)

# ファイルハッシュ（100点デザインの証明）
declare -A FILE_HASHES
FILE_HASHES["public/index.html"]="$(md5 -q public/index.html 2>/dev/null || md5sum public/index.html 2>/dev/null | cut -d' ' -f1)"
FILE_HASHES["public/styles-v2.css"]="$(md5 -q public/styles-v2.css 2>/dev/null || md5sum public/styles-v2.css 2>/dev/null | cut -d' ' -f1)"

# 変更されたファイルをチェック
MODIFIED_PROTECTED=()
for file in "${PROTECTED_FILES[@]}"; do
    if git diff --cached --name-only | grep -q "^$file$"; then
        MODIFIED_PROTECTED+=("$file")
    fi
done

# 保護されたファイルが変更された場合
if [ ${#MODIFIED_PROTECTED[@]} -gt 0 ]; then
    echo ""
    echo "⚠️  DESIGN PROTECTION ALERT!"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "🎨 The following 100-point design files are protected:"
    for file in "${MODIFIED_PROTECTED[@]}"; do
        echo "   • $file"
    done
    echo ""
    echo "🚨 These files contain the perfected UI/UX design and should not be modified."
    echo "💡 If you absolutely need to make changes:"
    echo "   1. Create a backup: git stash"
    echo "   2. Override protection: git commit --no-verify"
    echo "   3. Or contact the design team for approval"
    echo ""
    echo "🏆 Current design status: 100/100 points"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
fi

# チャットボット機能の整合性チェック
if git diff --cached --name-only | grep -q "server.js\|package.json"; then
    echo "🔍 Checking chatbot functionality integrity..."
    
    # Node.jsの基本チェック
    if ! node -e "console.log('Node.js check passed')" > /dev/null 2>&1; then
        echo "❌ Node.js environment check failed"
        exit 1
    fi
    
    echo "✅ Chatbot functionality integrity maintained"
fi

echo "✅ All protected design files are safe"
echo "🎨 100-point design integrity confirmed"
echo "🚀 Proceeding with commit..."